name: Master Builder

on: [push]

jobs:
    name: Tag
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.tag_version.outputs.new_tag }}
    steps:
      - uses: actions/checkout@v2
      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v5.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tag_prefix: ""
          
    docker-build-and-push:
      name: "docker-build: build image and push by workflow_dispatch"
      runs-on:
        - self-hosted
      if: ${{ github.event_name == 'workflow_dispatch' }}
      steps:
        - name: Checkout
          uses: actions/checkout@v2

        - name: Checkout GitHub Action Repo
          uses: actions/checkout@v2
          with:
            repository: test
            ref: main
        - uses: actions/checkout@v2
        - name: Login to Docker Hub
          uses: docker/login-action@v1
          with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}
        - name: Docker build and push
          uses: ./.github/actions/docker-build
          with:
            push: true
            tags: ${{ secrets.DOCKERHUB_USERNAME }}/helloworld-golang:${{needs.tag.outputs.new_tag}}         
